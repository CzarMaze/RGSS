#encoding:utf-8
#==============================================================================
# ■ CardBattle::Sprite_BattleCard
#------------------------------------------------------------------------------
#     戰鬥用卡片的精靈
#==============================================================================
module CardBattle
class Sprite_BattleCard < Sprite_Card
  #--------------------------------------------------------------------------
  # ● 加入移動元件
  #--------------------------------------------------------------------------
  include SpriteSlider
  include SpriteFader
  #--------------------------------------------------------------------------
  # ● 定義實例變數
  #--------------------------------------------------------------------------
  attr_reader :reserved_card
  attr_reader :index
  #--------------------------------------------------------------------------
  # ● 初始化對象
  #--------------------------------------------------------------------------
  def initialize(spriteset,index,viewport)
    @spriteset = spriteset
    super(viewport)
    set_index(index)
    # init_position
    slider_init
    fader_init
  end
  #--------------------------------------------------------------------------
  # ● 清除
  #--------------------------------------------------------------------------
  def clear
    super
    @reserved_card = false
    @effect_count = 0
  end
  #--------------------------------------------------------------------------
  # ● 清除保留
  #--------------------------------------------------------------------------
  def clear_reserve
    @reserved_card = false
  end
  #--------------------------------------------------------------------------
  # ● 設置Z座標為原始設定
  #--------------------------------------------------------------------------
  def set_z
    self.z = @index + 100
  end
  #--------------------------------------------------------------------------
  # ● 設定index
  #--------------------------------------------------------------------------
  def set_index(index)
    puts "設定index為#{index}，卡片為：#{@card_obj.inspect}"
    @index = index
    set_z
  end
  #--------------------------------------------------------------------------
  # ● 設定卡片物件 (由物件實體)
  #--------------------------------------------------------------------------
  def set_card_object(obj)
    super
    center_origin 
    # @effect_count = 60
  end
  #--------------------------------------------------------------------------
  # ● 保留當前卡片
  #--------------------------------------------------------------------------
  def set_reserve_current
    @reserved_card = true
    to_reserved_effect
  end
  #--------------------------------------------------------------------------
  # ● 設定保留卡片
  #--------------------------------------------------------------------------
  def set_reserve(obj)
    @reserved_card = true
    set_card_object(obj)
  end
  #--------------------------------------------------------------------------
  # ● 釋放
  #--------------------------------------------------------------------------
  def dispose
    super
  end
  #--------------------------------------------------------------------------
  # ● 更新
  #--------------------------------------------------------------------------
  def update
    super
    if @effect_count > 0
      @effect_count -= 1
    end
    slider_update
    fader_update
  end
  #--------------------------------------------------------------------------
  # ● 是否效果中？
  #--------------------------------------------------------------------------
  def effect?
    @effect_count > 0 || slider_sliding? || fader_fading? 
  end
  #--------------------------------------------------------------------------
  # ● 初始化位置
  #--------------------------------------------------------------------------
  def init_position
    
    if @spriteset.is_a?(Spriteset_PlayerBattleCards)
      self.y = 550
      self.x = 270 + @index*80
    else
      self.y = 50
      self.x = 135 + @index*80
    end
  end
  #--------------------------------------------------------------------------
  # ● 淡出並清除
  #--------------------------------------------------------------------------
  def fading_clear
    fader_set_post_handler(method(:post_fading_clear_handler))
    fader_set_fade(0,BATTLE_CARD_FADING_TIME)
    self.z = 0
  end
  #--------------------------------------------------------------------------
  # ● 淡出並清除之後的handler
  #--------------------------------------------------------------------------
  def post_fading_clear_handler
    fader_clear_handler
    clear
    set_bitmap
    set_z
  end
  #--------------------------------------------------------------------------
  # ● 設置保留效果之後的處理
  #--------------------------------------------------------------------------
  def set_post_reserve
    slider_set_post_handler(method(:post_reserve_handler))
  end
  #--------------------------------------------------------------------------
  # ● 保留移動之後的handler
  #--------------------------------------------------------------------------
  def post_reserve_handler
    puts "移動之後方法呼叫！"
    to_unreserve_effect
  end
  #--------------------------------------------------------------------------
  # ● 標註卡片已使用
  #--------------------------------------------------------------------------
  def mark_card_used
    if @card_obj
      @card_obj.used = true
    end
  end
  #--------------------------------------------------------------------------
  # ● 更換至攤牌，有效果
  #--------------------------------------------------------------------------
  def uncover_card_with_effect
    @cover = false
    start_animation_id(UNCOVER_CARD_ANIMATION_ID)
    set_bitmap
    if !card_usable?
      self.opacity = [self.opacity,50].min
    end
  end
  #--------------------------------------------------------------------------
  # ● 更換至蓋牌，有效果
  #--------------------------------------------------------------------------
  def cover_card_with_effect
    @cover = true
    start_animation_id(UNCOVER_CARD_ANIMATION_ID)
    set_bitmap
  end
  #--------------------------------------------------------------------------
  # ● 更換至蓋牌，無效果
  #--------------------------------------------------------------------------
  def cover_card
    @cover = true
    set_bitmap
  end
  #--------------------------------------------------------------------------
  # ● 設置：移動到位置後，攤牌
  #--------------------------------------------------------------------------
  def set_uncover_after_slide
    slider_set_post_handler(method(:handler_post_slide_uncover))
  end
  #--------------------------------------------------------------------------
  # ● 移動後的攤牌處理
  #--------------------------------------------------------------------------
  def handler_post_slide_uncover
    slider_clear_post_handler
    uncover_card_with_effect
  end
  #--------------------------------------------------------------------------
end
end
