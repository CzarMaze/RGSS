#encoding:utf-8
#==============================================================================
# ■ Spriteset_CardPage
#------------------------------------------------------------------------------
#  卡牌顯示頁，內部包含標籤以及多組卡牌精靈
#==============================================================================
module Lctseng
class Spriteset_CardPage
  #--------------------------------------------------------------------------
  # ● 初始化對象
  #--------------------------------------------------------------------------
  def initialize(master)
    @master = master
    @viewport = Viewport.new
    create_sprites
  end
  #--------------------------------------------------------------------------
  # ● 產生精靈
  #--------------------------------------------------------------------------
  def create_sprites
    # 不主動產生精靈
    @tags = [] # 標籤
    @cards = [] # 卡片
  end
  #--------------------------------------------------------------------------
  # ● 產生標籤精靈
  #--------------------------------------------------------------------------
  def add_tag
    s = Sprite.new(@viewport)
    opts = {}
    yield s,opts
    case opts[:pos]
    when :up
      s.set_pos([16,107])
    when :down
      s.set_pos([16,254])
    end
    s.bitmap = bitmap_loader.call(opts[:filename])
    @tags.push s
  end
  #--------------------------------------------------------------------------
  # ● 產生卡片精靈
  #--------------------------------------------------------------------------
  def add_card
    s = card_item_class.new(self,@viewport)
    opts = {}
    yield s,opts
    s.create_sprites(opts)
    @cards.push s
  end
  #--------------------------------------------------------------------------
  # ● 卡片精靈類別
  #--------------------------------------------------------------------------
  def card_item_class
    Spriteset_CardPageItem
  end
  #--------------------------------------------------------------------------
  # ● 位圖讀取器
  #--------------------------------------------------------------------------
  def bitmap_loader
    Cache.method(:pictures)
  end
  #--------------------------------------------------------------------------
  # ● 釋放
  #--------------------------------------------------------------------------
  def dispose
    @tags.each {|s| s.dispose}
    @cards.each {|s| s.dispose}
    @viewport.dispose
  end
  #--------------------------------------------------------------------------
  # ● 更新
  #--------------------------------------------------------------------------
  def update
    @cards.each {|s| s.update}
  end
  #--------------------------------------------------------------------------
  # ● 觸發確認鍵
  #--------------------------------------------------------------------------
  def process_ok
    @cards.each {|s| s.process_ok}
  end
  #--------------------------------------------------------------------------
  # ● 取得角色
  #--------------------------------------------------------------------------
  def actor
    @master.actor
  end
  #--------------------------------------------------------------------------
  # ● 點選箭頭時
  #--------------------------------------------------------------------------
  def on_arrow_click
    @master.on_arrow_click
  end
  #--------------------------------------------------------------------------
  # ● 刷新箭頭是否可以按
  #--------------------------------------------------------------------------
  def refresh_arrow_enabled
    @cards.each {|s| s.refresh_arrow_enabled}
  end
  
  #--------------------------------------------------------------------------
  # ● 設定可視
  #--------------------------------------------------------------------------
  def visible=(val)
    @viewport.visible = val
  end
  #--------------------------------------------------------------------------
  # ● 全部刷新
  #--------------------------------------------------------------------------
  def refresh_all
    @cards.each {|s| s.refresh}
  end

end
end